<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>3D Turbine Viewer (v3 model layer)</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- Mapbox GL JS v3: CSS and JS MUST be proper tags -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.18.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.18.1/mapbox-gl.js" defer></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }
    .debug {
      position: absolute; top: 8px; left: 8px; z-index: 1;
      background: #0008; color: #fff; padding: 6px 8px; border-radius: 4px;
      font: 12px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="debug" id="dbg">Loading…</div>

  <!-- Your code runs after DOM and after the Mapbox script (because of defer + DOMContentLoaded) -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      // --- Tune these if needed ---
      const START_SCALE = 20;   // Try 5..40 until it looks right
      const zOffset = 0;        // Lift model a few meters if needed (e.g., 5 or 10)

      if (!window.mapboxgl) {
        document.getElement load';
        return;
      }

      mapboxgl.accessToken = "pk.eyJ1IjoiZ3JlaWdydXNzZWxsIiwiYSI6ImNtbGY0ZjduYTAwdGwzZnNmNWNkbXJ4NTkifQ.5RoqcgVSVJ1gsA6WAXa0YQ";

      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/standard-satellite',
        center: [-2.250545, 57.349046],
        zoom: 13,
        pitch: 70,
        bearing: 20,
        antialias: true
      });

      const once = (target, ev) => new Promise(res => target.once(ev, res));

      map.on('style.load', async () => {
        const dbg = document.getElementById('dbg');
        dbg.textContent = `GL JS ${mapboxgl.version} | style loaded`;

        // 1) DEM terrain
        map.addSource('mapbox-dem', {
          type: 'raster-dem',
          url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
          tileSize: 512,
          maxzoom: 14
        });
        map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.0 });

        // 2) Register GLB model
        map.addModel('turbine', 'models/turbine.glb');

        dbg.textContent = 'Model registered… loading coordinates';

        // 3) Load coordinates file
        const text = await fetch('data/turbines.txt', { cache: 'no-cache' }).then(r => r.text());
        const lines = text.trim().split(/\r?\n/);

        const features = [];
        for (let i = 0; i < lines.length; i++) {
          const raw = lines[i].trim();
          if (!raw || raw.startsWith('#')) continue;
          const parts = raw.split(',').map(s => s.trim());
          if (parts.length < 5) continue;

          const type = parts[0];               // unused here
          const bearing = Number(parts[1] || 0);
          const name = parts[2] || `T${i+1}`;
          const lat  = Number(parts[3]);
          const lon  = Number(parts[4]);

          features.push({
            type: 'Feature',
            id: name, // promoteId target
            properties: { name, bearing, type },
            geometry: { type: 'Point', coordinates: [lon, lat] }
          });
        }

        map.addSource('turbines', {
          type: 'geojson',
          data: { type: 'FeatureCollection', features },
          promoteId: 'id'
        });

        // Pre-seed z=0 to avoid initial null on first paint
        for (const f of features) {
          map.setFeatureState({ source: 'turbines', id: f.id }, { z: 0 });
        }

        // 4) Model layer
        map.addLayer({
          id: 'turbine-models',
          type: 'model',
          source: 'turbines',
          layout: {
            'model-id': 'turbine'
          },
          paint: {
            // If your model lies down, change to [90, ['get','bearing'], 0]
            'model-rotation': [0, ['get', 'bearing'], 0],
            'model-translation': [0, 0, ['+', ['coalesce', ['feature-state', 'z'], 0], zOffset]],
            'model-scale': [START_SCALE, START_SCALE, START_SCALE]
          }
        });

        // 5) After terrain is ready, set real Z
        await once(map, 'idle');

        let minLng = Infinity, minLat = Infinity, maxLng = -Infinity, maxLat = -Infinity;

        for (const f of features) {
          const [lng, lat] = f.geometry.coordinates;
          const z = map.queryTerrainElevation([lng, lat], { exaggerated: false }) || 0;
          map.setFeatureState({ source: 'turbines', id: f.id }, { z });

          minLng = Math.min(minLng, lng); minLat = Math.min(minLat, lat);
          maxLng = Math.max(maxLng, lng); maxLat = Math.max(maxLat, lat);
          console.log(`Placed ${f.id} @ [${lng.toFixed(6)}, ${lat.toFixed(6)}], z=${Math.round(z)} m`);
        }

        if (features.length) {
          map.fitBounds([[minLng, minLat], [maxLng, maxLat]], {
            padding: 120, pitch: 70, bearing: 20, duration: 1200
          });
        }

        dbg.textContent = `Loaded ${features.length} turbine(s).`;
      });
    });
  </script>
</body>
</html>
